# ==============================================================================
# Continuous Integration Pipeline
# Runs on Pull Requests and pushes to the main branch.
# Executes unit tests with coverage enforcement, code linting, static security
# analysis (CodeQL), and container image vulnerability scanning (Trivy).
# ==============================================================================

name: CI

# ------------------------------------------------------------------------------
# Triggers
# ------------------------------------------------------------------------------
on:
  pull_request:
    branches:
      - main
    # Ignore documentation changes
    paths-ignore:
      - "docs/**"
      - "README.md"
      - ".github/**"
  push:
    branches:
      - main
    # Ignore documentation changes
    paths-ignore:
      - "docs/**"
      - "README.md"
      - ".github/**"

# ------------------------------------------------------------------------------
# Concurrency
# ------------------------------------------------------------------------------
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ------------------------------------------------------------------------------
# Environment Variables
# ------------------------------------------------------------------------------
env:
  PYTHON_VERSION: "3.x"

# ------------------------------------------------------------------------------
# Jobs
# ------------------------------------------------------------------------------
jobs:
  # ----------------------------------------------------------------------------
  # Tests: Unit tests with coverage enforcement
  # ----------------------------------------------------------------------------
  tests:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run healthcheck tests
        run: pytest tests/healthchecks -v

      - name: Run setup tests with coverage
        run: |
          pytest tests/ --ignore=tests/healthchecks --cov=scripts --cov-report=xml --cov-report=term-missing --cov-fail-under=60 -v

      - name: Check coverage threshold
        run: coverage report --fail-under=60

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # ----------------------------------------------------------------------------
  # Lint: Python code quality checks
  # ----------------------------------------------------------------------------
  lint-python:
    name: Lint Python
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run flake8
        run: flake8 scripts/ tests/ --max-line-length=100 --extend-ignore=E203,W503
        continue-on-error: true

      - name: Run Pylint
        run: pylint scripts/setup/*.py --fail-under=8.0
        continue-on-error: true

  # ----------------------------------------------------------------------------
  # Lint: Shell script checks
  # ----------------------------------------------------------------------------
  lint-shell:
    name: Lint Shell
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: "./scripts"
          severity: warning
          ignore_paths: |
            node_modules
            .git

  # ----------------------------------------------------------------------------
  # Integration: Import and Playwright setup checks
  # ----------------------------------------------------------------------------
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install chromium --with-deps

      - name: Create test environment file
        run: |
          cat > .env << EOF
          SERVICE_USER=testuser
          QBITTORRENT_PASSWORD=testpass
          SONARR_PASS=testpass
          RADARR_PASS=testpass
          PROWLARR_PASS=testpass
          BAZARR_PASS=testpass
          EOF

      - name: Test setup scripts can be imported
        run: python -c "import sys; sys.path.insert(0, 'scripts/setup'); import common, extract_api_keys, bootstrap"

  # ----------------------------------------------------------------------------
  # Dependencies: Python package vulnerability audit
  # ----------------------------------------------------------------------------
  check-dependencies:
    name: Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit

      - name: Audit dependencies
        run: pip-audit -r requirements.txt
        continue-on-error: true

  # ----------------------------------------------------------------------------
  # CodeQL: Static security analysis
  # ----------------------------------------------------------------------------
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: ["python"]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          queries: +security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{ matrix.language }}"
