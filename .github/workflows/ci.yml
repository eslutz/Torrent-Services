# ==============================================================================
# Continuous Integration Pipeline
# Runs on Pull Requests and pushes to the main branch.
#
# Pipeline Stages:
# 1. FAST FAIL - Docker, environment, and shell validation
# 2. QUALITY CHECKS - Python and shell linting
# 3. COMPREHENSIVE TESTS - Unit tests with 60% coverage enforcement
# 4. SECURITY SCANS - CodeQL, Trivy, dependency audit (parallel)
# ==============================================================================

name: CI

# ------------------------------------------------------------------------------
# Triggers
# ------------------------------------------------------------------------------
on:
  pull_request:
    branches:
      - main
    # Ignore documentation changes
    paths-ignore:
      - "docs/**"
      - "README.md"
      - ".github/**"
  push:
    branches:
      - main
    # Ignore documentation changes
    paths-ignore:
      - "docs/**"
      - "README.md"
      - ".github/**"

# ------------------------------------------------------------------------------
# Concurrency
# ------------------------------------------------------------------------------
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ------------------------------------------------------------------------------
# Environment Variables
# ------------------------------------------------------------------------------
env:
  PYTHON_VERSION: "3.x"

# ------------------------------------------------------------------------------
# Jobs
# ------------------------------------------------------------------------------
jobs:
  # ------------------------------------------------------------------------------
  # FAST FAIL - Catch basic errors immediately
  # ------------------------------------------------------------------------------

  # Validate: Docker Compose syntax and configuration
  validate-docker:
    name: Validate Docker Compose
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Validate docker-compose.yml syntax
        run: docker compose config --quiet

      - name: Check service health checks exist
        run: |
          echo "Verifying health check scripts for all services..."
          for service in gluetun qbittorrent sonarr radarr prowlarr bazarr; do
            if ! grep -q "test:.*\/scripts\/${service}.sh" docker-compose.yml; then
              echo "ERROR: Missing health check for ${service}"
              exit 1
            fi
            echo "✓ ${service} health check found"
          done
          echo "All health checks verified"

  # Validate: Environment file configuration
  validate-env:
    name: Validate Environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check .env.example has all required keys
        run: |
          echo "Checking .env.example for required environment variables..."
          required_keys="SERVICE_USER QBITTORRENT_PASSWORD SONARR_PASSWORD RADARR_PASSWORD PROWLARR_PASSWORD BAZARR_PASSWORD"
          missing=0
          for key in $required_keys; do
            if ! grep -q "^${key}=" .env.example; then
              echo "ERROR: Missing required key: ${key}"
              missing=1
            else
              echo "✓ ${key} found"
            fi
          done
          if [ $missing -eq 1 ]; then
            exit 1
          fi
          echo "All required environment variables present"

  # Validate: Shell scripts
  validate-shell:
    name: Validate Shell Scripts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Verify health check scripts exist
        run: |
          echo "Checking for required health check scripts..."
          missing=0
          for script in bazarr gluetun prowlarr qbittorrent radarr sonarr; do
            if [ ! -f "scripts/healthchecks/${script}.sh" ]; then
              echo "ERROR: Missing health check script: ${script}.sh"
              missing=1
            else
              echo "✓ scripts/healthchecks/${script}.sh exists"
            fi
          done
          if [ $missing -eq 1 ]; then
            exit 1
          fi
          echo "All health check scripts present"

      - name: Check scripts are executable
        run: |
          echo "Checking script permissions..."
          non_executable=$(find scripts -name "*.sh" -type f ! -executable -print)
          if [ -n "$non_executable" ]; then
            echo "ERROR: Found non-executable shell scripts:"
            echo "$non_executable"
            exit 1
          fi
          echo "All shell scripts are executable"

  # ------------------------------------------------------------------------------
  # QUALITY CHECKS - Code style and static analysis
  # ------------------------------------------------------------------------------

  # Lint: Shell script checks
  lint-shell:
    name: Lint Shell
    runs-on: ubuntu-latest
    needs: validate-shell
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: "./scripts"
          severity: warning

  # Lint: Python script checks
  lint-python:
    name: Lint Python
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run flake8
        run: flake8 scripts/ tests/ --max-line-length=100 --extend-ignore=E203,W503
        continue-on-error: true

      - name: Run Pylint
        run: pylint scripts/setup/*.py --fail-under=8.0
        continue-on-error: true

  # ------------------------------------------------------------------------------
  # COMPREHENSIVE TESTS - Full validation
  # ------------------------------------------------------------------------------

  # Tests: Unit tests with coverage enforcement
  tests:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run healthcheck tests (no coverage)
        run: pytest tests/healthchecks -v --no-cov

      - name: Run setup tests with coverage
        run: |
          pytest tests/ --ignore=tests/healthchecks --cov=scripts --cov-report=xml --cov-report=term-missing --cov-fail-under=60 -v

      - name: Check coverage threshold
        run: coverage report --fail-under=60

  # ------------------------------------------------------------------------------
  # SECURITY SCANS - Vulnerability analysis and dependency auditing
  # ------------------------------------------------------------------------------

  # Dependencies: Python package vulnerability audit
  check-dependencies:
    name: Dependency Audit
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit

      - name: Audit dependencies
        run: |
          # Run pip-audit and capture exit code
          # Exit codes: 0 = no vulnerabilities, 1 = vulnerabilities found, 2+ = error
          pip-audit --requirement requirements.txt --format json --output pip-audit-results.json || EXIT_CODE=$?
          if [ "${EXIT_CODE:-0}" -ge 2 ]; then
            echo "Error: pip-audit failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          fi

      - name: Convert pip-audit to SARIF
        run: |
          python3 << 'EOF'
          import json
          import sys
          from datetime import datetime

          with open('pip-audit-results.json') as f:
              audit_data = json.load(f)

          sarif = {
              "version": "2.1.0",
              "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
              "runs": [{
                  "tool": {
                      "driver": {
                          "name": "pip-audit",
                          "version": "2.0.0",
                          "informationUri": "https://github.com/pypa/pip-audit"
                      }
                  },
                  "results": []
              }]
          }

          for vuln in audit_data.get('vulnerabilities', []):
              sarif['runs'][0]['results'].append({
                  "ruleId": vuln['id'],
                  "level": "warning",
                  "message": {"text": vuln['description']},
                  "locations": [{
                      "physicalLocation": {
                          "artifactLocation": {"uri": "requirements.txt"},
                          "region": {"startLine": 1}
                      }
                  }]
              })

          with open('pip-audit-results.sarif', 'w') as f:
              json.dump(sarif, f, indent=2)
          EOF

      - name: Upload pip-audit results to Security tab
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: pip-audit-results.sarif
          category: pip-audit

  # CodeQL: Static security analysis
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: ["python"]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          queries: security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{matrix.language}}"

  # Trivy: Vulnerability and misconfiguration scanning
  trivy:
    name: Trivy Filesystem Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          ignore-unfixed: true
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"

      - name: Upload Trivy results to Security tab
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results.sarif
          category: trivy-filesystem
