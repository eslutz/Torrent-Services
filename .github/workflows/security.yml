# ==============================================================================
# Security Pipeline
# Comprehensive security scanning run on a weekly schedule.
# ==============================================================================

name: Security

# ------------------------------------------------------------------------------
# Triggers
# ------------------------------------------------------------------------------
on:
  schedule:
    - cron: "30 1 * * 0" # Weekly on Sunday at 01:30 UTC

# ------------------------------------------------------------------------------
# Concurrency
# ------------------------------------------------------------------------------
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ------------------------------------------------------------------------------
# Permissions
# ------------------------------------------------------------------------------
permissions:
  contents: read
  security-events: write

# ------------------------------------------------------------------------------
# Environment Variables
# ------------------------------------------------------------------------------
env:
  PYTHON_VERSION: "3.x"

# ------------------------------------------------------------------------------
# Jobs
# ------------------------------------------------------------------------------
jobs:
  # ----------------------------------------------------------------------------
  # Python Dependencies - pip-audit vulnerability scanning
  # ----------------------------------------------------------------------------
  check-dependencies:
    name: Dependency Audit
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit

      - name: Audit dependencies
        run: |
          # Run pip-audit and capture exit code
          # Exit codes: 0 = no vulnerabilities, 1 = vulnerabilities found, 2+ = error
          pip-audit --requirement requirements.txt --format json --output pip-audit-results.json || EXIT_CODE=$?
          if [ "${EXIT_CODE:-0}" -ge 2 ]; then
            echo "Error: pip-audit failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          fi

      - name: Convert pip-audit to SARIF
        run: |
          python3 << 'EOF'
          import json
          import sys
          from datetime import datetime

          with open('pip-audit-results.json') as f:
              audit_data = json.load(f)

          sarif = {
              "version": "2.1.0",
              "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
              "runs": [{
                  "tool": {
                      "driver": {
                          "name": "pip-audit",
                          "version": "2.0.0",
                          "informationUri": "https://github.com/pypa/pip-audit"
                      }
                  },
                  "results": []
              }]
          }

          for vuln in audit_data.get('vulnerabilities', []):
              sarif['runs'][0]['results'].append({
                  "ruleId": vuln['id'],
                  "level": "warning",
                  "message": {"text": vuln['description']},
                  "locations": [{
                      "physicalLocation": {
                          "artifactLocation": {"uri": "requirements.txt"},
                          "region": {"startLine": 1}
                      }
                  }]
              })

          with open('pip-audit-results.sarif', 'w') as f:
              json.dump(sarif, f, indent=2)
          EOF

      - name: Upload pip-audit results to Security tab
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: pip-audit-results.sarif
          category: pip-audit

  # ----------------------------------------------------------------------------
  # CodeQL - Static security analysis
  # ----------------------------------------------------------------------------
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: ["python"]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          queries: security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{matrix.language}}"

  # ----------------------------------------------------------------------------
  # Trivy - Filesystem vulnerability scanning
  # Scans source code, dependencies, and configuration files
  # ----------------------------------------------------------------------------
  trivy-filesystem:
    name: Trivy Filesystem Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          ignore-unfixed: true
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"

      - name: Upload Trivy results to Security tab
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results.sarif
          category: trivy-filesystem

  # ----------------------------------------------------------------------------
  # Trivy - Container image vulnerability scanning
  # Scans all images from docker-compose.yml files
  # ----------------------------------------------------------------------------
  trivy-compose-images:
    name: Trivy Compose Scan
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compose-path:
          - network-services/docker-compose.yml
          - torrent-services/docker-compose.yml
      fail-fast: false
    steps:
      - name: Checkout Source
        uses: actions/checkout@v6

      - name: Check compose file exists
        id: check-file
        run: |
          if [ -f "${{ matrix.compose-path }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Warning: ${{ matrix.compose-path }} not found"
          fi

      - name: Extract images from docker-compose.yml
        if: steps.check-file.outputs.exists == 'true'
        id: extract-images
        run: |
          # Extract image names, handling both image: and ${VAR} formats
          images=$(grep -E '^\s+image:' ${{ matrix.compose-path }} | \
                   awk '{print $2}' | \
                   grep -v '^\${' | \
                   sort -u | \
                   tr '\n' ' ')
          echo "images=$images" >> $GITHUB_OUTPUT
          echo "Found images: $images"

      - name: Scan images with Trivy
        if: steps.check-file.outputs.exists == 'true' && steps.extract-images.outputs.images != ''
        run: |
          mkdir -p trivy-results
          for image in ${{ steps.extract-images.outputs.images }}; do
            # Sanitize image name for filename
            safe_name=$(echo "$image" | tr '/:.' '-')
            echo "Scanning $image..."

            docker run --rm \
              -v /var/run/docker.sock:/var/run/docker.sock \
              -v ${{ github.workspace }}/trivy-results:/results \
              aquasec/trivy:latest image \
              --format sarif \
              --output /results/${safe_name}.sarif \
              --severity CRITICAL,HIGH \
              --ignore-unfixed \
              "$image" || echo "::warning::Scan failed for $image"
          done

      - name: Upload Trivy results to GitHub Security
        if: steps.check-file.outputs.exists == 'true' && steps.extract-images.outputs.images != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results/
          category: trivy-${{ matrix.compose-path }}
