#!/usr/bin/env bash
set -euo pipefail

# Repo-tracked pre-commit hook. Requires `git config core.hooksPath .githooks`.
# Runs only when staged "code" files change (not docs).

repo_root="$(git rev-parse --show-toplevel)"
cd "$repo_root"

# Staged files (Added/Copied/Modified/Renamed)
mapfile -t staged_files < <(git diff --cached --name-only --diff-filter=ACMR)

if [ ${#staged_files[@]} -eq 0 ]; then
  exit 0
fi

is_code_file() {
  local f="$1"

  # Only treat these paths as "code" for this repo
  case "$f" in
    scripts/*|tests/*|.github/workflows/*|docker-compose.yml|pyproject.toml|requirements.txt)
      ;;
    *)
      return 1
      ;;
  esac

  # Exclude documentation-like files even if they live in these paths
  case "$f" in
    *.md|*.rst|*.txt)
      return 1
      ;;
  esac

  return 0
}

code_files=()
python_files=()
shell_files=()

for f in "${staged_files[@]}"; do
  if ! is_code_file "$f"; then
    continue
  fi

  code_files+=("$f")

  case "$f" in
    *.py)
      python_files+=("$f")
      ;;
    *.sh)
      shell_files+=("$f")
      ;;
  esac

done

# If no relevant code changes are staged, skip.
if [ ${#code_files[@]} -eq 0 ]; then
  exit 0
fi

echo "pre-commit: staged code changes detected; running lint + unit tests..."

venv_python="venv/bin/python3"
if [ ! -x "$venv_python" ]; then
  echo "ERROR: $venv_python not found/executable. Create venv and install deps:" >&2
  echo "  python3 -m venv venv" >&2
  echo "  venv/bin/pip install -r requirements.txt" >&2
  exit 1
fi

# -----------------------------
# Lint (Python)
# -----------------------------
if [ ${#python_files[@]} -gt 0 ]; then
  echo "pre-commit: flake8 (${#python_files[@]} file(s))"
  "$venv_python" -m flake8 "${python_files[@]}" --max-line-length=100 --extend-ignore=E203,W503

  # Keep pylint scope aligned with CI (scripts/setup only), but still fail the commit if it fails.
  if compgen -G "scripts/setup/*.py" >/dev/null; then
    echo "pre-commit: pylint (scripts/setup/*.py)"
    "$venv_python" -m pylint scripts/setup/*.py --fail-under=8.0
  fi
fi

# -----------------------------
# Lint (Shell)
# -----------------------------
if [ ${#shell_files[@]} -gt 0 ]; then
  if command -v shellcheck >/dev/null 2>&1; then
    echo "pre-commit: shellcheck (${#shell_files[@]} file(s))"
    shellcheck "${shell_files[@]}"
  else
    echo "ERROR: shellcheck is required to commit shell script changes." >&2
    echo "Install shellcheck and re-try (macOS: brew install shellcheck)." >&2
    exit 1
  fi
fi

# -----------------------------
# Unit tests
# -----------------------------
echo "pre-commit: pytest"
"$venv_python" -m pytest tests/

echo "pre-commit: OK"
