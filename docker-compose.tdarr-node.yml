# Additional Tdarr Node for Horizontal Scaling
#
# This compose file allows you to dynamically add more Tdarr transcode nodes
# without modifying the main docker-compose.yml file.
#
# RECOMMENDED: Use the helper scripts for automatic unique name generation:
#   Start node:  ./scripts/utilities/start_tdarr_node.sh
#   Manage:      ./scripts/utilities/manage_tdarr_nodes.sh list
#   Stop:        ./scripts/utilities/manage_tdarr_nodes.sh stop <unique-id>
#
# MANUAL USAGE (Advanced):
#   Start additional node:
#     docker compose -f docker-compose.tdarr-node.yml --project-name tdarr-node-2 up -d
#     docker compose -f docker-compose.tdarr-node.yml --project-name tdarr-node-3 up -d
#
#   Stop a node:
#     docker compose -f docker-compose.tdarr-node.yml --project-name tdarr-node-2 down
#
#   View running nodes:
#     docker ps --filter "name=tdarr-node"
#
# Environment Variables (optional):
#   TDARR_NODE_CONTAINER_NAME  # Container name (auto-generated by script)
#   TDARR_NODE_ID              # Unique node ID (auto-generated by script)
#   TDARR_NODE_MEM_LIMIT=2g    # Memory limit (default: 2g)
#   TDARR_NODE_CPUS=2.0        # CPU limit (default: 2.0)
#   TDARR_GPU_WORKERS=0        # GPU workers (default: 0, requires GPU passthrough)
#   TDARR_CPU_WORKERS=2        # CPU workers (default: 2)

services:
  tdarr-node-extra:
    image: ghcr.io/haveagitgat/tdarr:latest
    container_name: ${TDARR_NODE_CONTAINER_NAME:-tdarr-node-extra}
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      TZ: ${TZ:-America/New_York}
      # Generate unique node ID using timestamp if not provided
      nodeID: ${TDARR_NODE_ID:-TdarrNode-${RANDOM:-$$}}
      nodeIP: 0.0.0.0
      nodePort: 8267
      serverIP: ${TDARR_SERVER_IP:-tdarr-server}
      serverPort: ${TDARR_SERVER_PORT:-8266}
      # Optional: Customize worker counts
      transcodeGpuWorkers: ${TDARR_GPU_WORKERS:-0}
      transcodeCpuWorkers: ${TDARR_CPU_WORKERS:-2}
    # Increase file descriptor limit for ExFAT volumes on OrbStack
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - ${TORRENT_MEDIA_DIR:-./media}:/media
      - ${DVD_MEDIA_DIR:-./dvd-rips}:/dvd-rips
      - ./config/tdarr/configs:/app/configs
      - ./config/tdarr/logs:/app/logs
      # Each node gets its own transcode cache to prevent conflicts
      - tdarr-transcode-cache-extra:/temp
    restart: unless-stopped
    stop_grace_period: 30s
    networks:
      - torrent-services-network
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: ${TDARR_NODE_MEM_LIMIT:-2g}
    cpus: ${TDARR_NODE_CPUS:-2.0}
    # Optional GPU passthrough (uncomment and configure for your GPU)
    # devices:
    #   - /dev/dri:/dev/dri  # Intel QuickSync
    # For NVIDIA GPUs, use:
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

networks:
  torrent-services-network:
    external: true
    name: torrent-net

volumes:
  tdarr-transcode-cache-extra:
    driver: local
