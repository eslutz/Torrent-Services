services:
  # Gluetun - VPN Client (ProtonVPN with Port Forwarding)
  # Provides VPN tunnel with automatic port forwarding for qBittorrent
  # Port forwarding enables incoming peer connections for better torrent performance
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      # ProtonVPN Configuration
      - VPN_SERVICE_PROVIDER=protonvpn
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - WIREGUARD_ADDRESSES=${WIREGUARD_ADDRESSES}

      # Server Selection
      - SERVER_COUNTRIES=${SERVER_COUNTRIES:-}
      - FREE_ONLY=${FREE_ONLY:-}

      # Port Forwarding (automatic)
      - VPN_PORT_FORWARDING=on
      - VPN_PORT_FORWARDING_PROVIDER=protonvpn

      # Timezone
      - TZ=${TZ:-America/New_York}
    ports:
      # qBittorrent Web UI
      - 8080:8080
      # Forwarded port will be automatically assigned by ProtonVPN
      # Check with: docker exec gluetun cat /tmp/gluetun/forwarded_port
    volumes:
      - ./config/gluetun:/gluetun
      - gluetun-tmp:/tmp/gluetun
      - ./scripts/healthchecks:/scripts:ro
    restart: unless-stopped
    networks:
      - torrent-services-network
    healthcheck:
      test: ["CMD-SHELL", "/scripts/gluetun.sh"]
      interval: 30s
      timeout: 15s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: ${GLUETUN_MEM_LIMIT:-256m}
    cpus: ${GLUETUN_CPUS:-0.5}

  # qBittorrent - Torrent Client
  # Routes through Gluetun VPN with automatic port forwarding
  # Port forwarding enables incoming peer connections for optimal performance
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    network_mode: "service:gluetun"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
      - WEBUI_PORT=8080
    volumes:
      - ./config/qbittorrent:/config
      - ${DATA_DIR:-./media}:/media
      - ./scripts/healthchecks:/scripts:ro
    depends_on:
      gluetun:
        condition: service_healthy
    restart: unless-stopped
    init: true
    stop_grace_period: 60s
    healthcheck:
      test: ["CMD-SHELL", "/scripts/qbittorrent.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: ${QBITTORRENT_MEM_LIMIT:-2g}
    cpus: ${QBITTORRENT_CPUS:-2.0}

  # qBit Port Sync - Automatically updates qBittorrent port from Gluetun
  # Monitors Gluetun's forwarded port and updates qBittorrent when it changes
  qbit-port-sync:
    image: alpine:latest
    container_name: qbit-port-sync
    environment:
      - QBIT_HOST=gluetun:8080
      - QBIT_USER=${QBIT_USER:-admin}
      - QBIT_PASS=${QBIT_PASS}
    volumes:
      - gluetun-tmp:/tmp/gluetun:ro
      - ./scripts/qbit-port-sync.sh:/app/qbit-port-sync.sh:ro
    depends_on:
      gluetun:
        condition: service_healthy
      qbittorrent:
        condition: service_healthy
    networks:
      - torrent-services-network
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /tmp:size=10M,mode=1777
    healthcheck:
      test: >
        /bin/sh -c '
        [ -f /tmp/qbit-port-sync-status ] && (grep -q "OK" /tmp/qbit-port-sync-status || grep -q "STARTING" /tmp/qbit-port-sync-status) || exit 1
        '
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 120s
    command: sh /app/qbit-port-sync.sh
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: ${QBIT_PORT_SYNC_MEM_LIMIT:-64m}
    cpus: ${QBIT_PORT_SYNC_CPUS:-0.1}

  # Prowlarr - Indexer Manager
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
      - PROWLARR_API_KEY=${PROWLARR_API_KEY:-}
    volumes:
      - ./config/prowlarr:/config
      - ./scripts/healthchecks:/scripts:ro
    ports:
      - 9696:9696
    depends_on:
      tor-proxy:
        condition: service_healthy
    restart: unless-stopped
    init: true
    networks:
      - torrent-services-network
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "/scripts/prowlarr.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: ${PROWLARR_MEM_LIMIT:-512m}
    cpus: ${PROWLARR_CPUS:-1.0}

  # Sonarr - TV Show Management
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
      - SONARR_API_KEY=${SONARR_API_KEY:-}
    volumes:
      - ./config/sonarr:/config
      - ${DATA_DIR:-./media}:/media
      - ./scripts/healthchecks:/scripts:ro
    ports:
      - 8989:8989
    depends_on:
      prowlarr:
        condition: service_healthy
    restart: unless-stopped
    init: true
    stop_grace_period: 30s
    networks:
      - torrent-services-network
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "/scripts/sonarr.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: ${SONARR_MEM_LIMIT:-1g}
    cpus: ${SONARR_CPUS:-1.0}

  # Radarr - Movie Management
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
      - RADARR_API_KEY=${RADARR_API_KEY:-}
    volumes:
      - ./config/radarr:/config
      - ${DATA_DIR:-./media}:/media
      - ./scripts/healthchecks:/scripts:ro
    ports:
      - 7878:7878
    depends_on:
      prowlarr:
        condition: service_healthy
    restart: unless-stopped
    init: true
    stop_grace_period: 30s
    networks:
      - torrent-services-network
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "/scripts/radarr.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: ${RADARR_MEM_LIMIT:-1g}
    cpus: ${RADARR_CPUS:-1.0}

  # Bazarr - Subtitle Management
  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
      - BAZARR_API_KEY=${BAZARR_API_KEY:-}
    volumes:
      - ./config/bazarr:/config
      - ${DATA_DIR:-./media}:/media
      - ./scripts/healthchecks:/scripts:ro
    ports:
      - 6767:6767
    depends_on:
      sonarr:
        condition: service_healthy
      radarr:
        condition: service_healthy
    restart: unless-stopped
    init: true
    networks:
      - torrent-services-network
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "/scripts/bazarr.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: ${BAZARR_MEM_LIMIT:-512m}
    cpus: ${BAZARR_CPUS:-0.5}

  # Tor - SOCKS5 proxy for anonymous indexer access
  # Provides access to .onion sites and bypasses blocks
  tor-proxy:
    image: dperson/torproxy:latest
    container_name: tor-proxy
    environment:
      - TZ=${TZ:-America/New_York}
    ports:
      - 127.0.0.1:9050:9050 # SOCKS5 proxy
      - 127.0.0.1:9051:9051 # Control port
    volumes:
      - ./scripts/healthchecks:/scripts:ro
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /var/lib/tor:size=100M,mode=0700
      - /var/log/tor:size=50M,mode=0755
    networks:
      - torrent-services-network
    healthcheck:
      test: ["CMD-SHELL", "/scripts/tor-proxy.sh"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: ${TOR_PROXY_MEM_LIMIT:-128m}
    cpus: ${TOR_PROXY_CPUS:-0.25}

  # qBittorrent Exporter for Prometheus
  qbittorrent-exporter:
    image: ghcr.io/martabal/qbittorrent-exporter:latest
    container_name: qbittorrent-exporter
    environment:
      - QBITTORRENT_BASE_URL=http://gluetun:8080
      - QBITTORRENT_USERNAME=${QBIT_USER:-admin}
      - QBITTORRENT_PASSWORD=${QBIT_PASS}
      - EXPORTER_PORT=8090
      - LOG_LEVEL=INFO
      - ENABLE_TRACKER=true
    depends_on:
      qbittorrent:
        condition: service_healthy
    ports:
      - "127.0.0.1:8090:8090"
    networks:
      - torrent-services-network
    restart: unless-stopped
    profiles:
      - monitoring
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    mem_limit: ${QBITTORRENT_EXPORTER_MEM_LIMIT:-128m}
    cpus: ${QBITTORRENT_EXPORTER_CPUS:-0.25}

  # Scraparr - Unified *arr Prometheus exporter
  scraparr:
    image: ghcr.io/thecfu/scraparr:latest
    container_name: scraparr
    environment:
      - GENERAL_PORT=7100
      - GENERAL_PATH=/metrics
      - SONARR_URL=http://sonarr:8989
      - SONARR_API_KEY=${SONARR_API_KEY}
      - SONARR_INTERVAL=30
      - RADARR_URL=http://radarr:7878
      - RADARR_API_KEY=${RADARR_API_KEY}
      - RADARR_INTERVAL=30
      - PROWLARR_URL=http://prowlarr:9696
      - PROWLARR_API_KEY=${PROWLARR_API_KEY}
      - PROWLARR_INTERVAL=30
      - BAZARR_URL=http://bazarr:6767
      - BAZARR_API_KEY=${BAZARR_API_KEY}
      - BAZARR_INTERVAL=30
    depends_on:
      sonarr:
        condition: service_healthy
      radarr:
        condition: service_healthy
      prowlarr:
        condition: service_healthy
      bazarr:
        condition: service_healthy
    ports:
      - "127.0.0.1:7100:7100"
    networks:
      - torrent-services-network
    restart: unless-stopped
    profiles:
      - monitoring
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    mem_limit: ${SCRAPARR_MEM_LIMIT:-256m}
    cpus: ${SCRAPARR_CPUS:-0.5}

  autoheal:
    image: tmknight88/docker-autoheal:latest
    container_name: autoheal
    restart: unless-stopped
    read_only: true
    user: "${PUID}:${PGID}"
    network_mode: none
    environment:
      - AUTOHEAL_CONNECTION_TYPE=socket
      - AUTOHEAL_MONITOR_ALL=true
      - AUTOHEAL_INTERVAL=30
      - AUTOHEAL_START_DELAY=300
      - AUTOHEAL_STOP_TIMEOUT=30
      - AUTOHEAL_LOG_PERSIST=true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/localtime:/etc/localtime:ro
      - autoheal-logs:/opt/docker-autoheal
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    mem_limit: ${AUTOHEAL_MEM_LIMIT:-64m}
    cpus: ${AUTOHEAL_CPUS:-0.1}

networks:
  torrent-services-network:
    name: torrent-net
    driver: bridge

volumes:
  gluetun-tmp:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
  autoheal-logs:
