services:
  # Gluetun - VPN Client (Mullvad WireGuard)
  # All torrent traffic routes through this container
  # Provides kill-switch protection: torrents stop if VPN connection drops
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      # Mullvad VPN Configuration
      - VPN_SERVICE_PROVIDER=mullvad
      - VPN_TYPE=wireguard

      # Mullvad WireGuard Credentials
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - WIREGUARD_ADDRESSES=${WIREGUARD_ADDRESSES}

      # Server Selection (optional - set in .env if needed)
      - SERVER_CITIES=${SERVER_CITIES:-}
      - SERVER_COUNTRIES=${SERVER_COUNTRIES:-}
      - SERVER_HOSTNAMES=${SERVER_HOSTNAMES:-}
      - OWNED_ONLY=${OWNED_ONLY:-}

      # Firewall settings
      - FIREWALL_OUTBOUND_SUBNETS=172.16.0.0/12 # Allow all Docker networks (172.16-172.31)

      # Health check
      - HEALTH_VPN_DURATION_INITIAL=30s

      # Timezone
      - TZ=${TZ:-America/New_York}
    ports:
      # qBittorrent Web UI (accessible on network)
      - 8080:8080
      # qBittorrent torrent port (accessible on network)
      - 6881:6881
      - 6881:6881/udp
    volumes:
      - ./gluetun:/gluetun
    restart: unless-stopped
    networks:
      - torrent-stack-network
    healthcheck:
      test: ["CMD-SHELL", "ping -c 1 1.1.1.1 > /dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

  # qBittorrent - Torrent Client
  # Routes through Gluetun VPN container
  # kill-switch: If VPN drops, qBittorrent loses internet connectivity
  # NOTE: Uses network_mode service:gluetun, accessible from other containers at gluetun:8080
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    network_mode: "service:gluetun"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
      - WEBUI_PORT=8080
    volumes:
      - ./qbittorrent/config:/config
      - ${DATA_DIR:-data}:/data
    depends_on:
      gluetun:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Sonarr - TV Show Management
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    volumes:
      - ./sonarr/config:/config
      - ${DATA_DIR:-data}:/data
    ports:
      - 8989:8989
    restart: unless-stopped
    networks:
      - torrent-stack-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8989/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

  # Radarr - Movie Management
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    volumes:
      - ./radarr/config:/config
      - ${DATA_DIR:-data}:/data
    ports:
      - 7878:7878
    restart: unless-stopped
    networks:
      - torrent-stack-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7878/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

  # Prowlarr - Indexer Manager
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    volumes:
      - ./prowlarr/config:/config
    ports:
      - 9696:9696
    restart: unless-stopped
    networks:
      - torrent-stack-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9696/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

  # Bazarr - Subtitle Management
  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    volumes:
      - ./bazarr/config:/config
      - ${DATA_DIR:-data}:/data
    ports:
      - 6767:6767
    restart: unless-stopped
    networks:
      - torrent-stack-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6767/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

networks:
  torrent-stack-network:
    name: torrent-net
    driver: bridge
