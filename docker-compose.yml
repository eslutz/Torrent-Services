services:
  # Gluetun - VPN Client (ProtonVPN with Port Forwarding)
  # Provides VPN tunnel with automatic port forwarding for qBittorrent
  # Port forwarding enables incoming peer connections for better torrent performance
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      # ProtonVPN Configuration
      VPN_SERVICE_PROVIDER: protonvpn
      OPENVPN_USER: ${OPENVPN_USER:-}
      OPENVPN_PASSWORD: ${OPENVPN_PASSWORD:-}
      # Server Selection Filters
      SERVER_COUNTRIES: ${SERVER_COUNTRIES:-}
      SERVER_CITIES: ${SERVER_CITIES:-}
      SERVER_HOSTNAMES: ${SERVER_HOSTNAMES:-}
      PORT_FORWARD_ONLY: on
      VPN_PORT_FORWARDING: on
      # DNS Settings
      DNS_UPSTREAM_RESOLVERS: ${DNS_UPSTREAM_RESOLVERS:-cloudflare}
      BLOCK_MALICIOUS: ${BLOCK_MALICIOUS:-on}
      BLOCK_ADS: ${BLOCK_ADS:-off}
      BLOCK_SURVEILLANCE: ${BLOCK_SURVEILLANCE:-off}
      # Updater Settings
      UPDATER_PERIOD: ${UPDATER_PERIOD:-0}
      UPDATER_MIN_RATIO: ${UPDATER_MIN_RATIO:-0.8}
      UPDATER_VPN_SERVICE_PROVIDERS: ${UPDATER_VPN_SERVICE_PROVIDERS:-}
      UPDATER_PROTONVPN_EMAIL: ${UPDATER_PROTONVPN_EMAIL:-}
      UPDATER_PROTONVPN_PASSWORD: ${UPDATER_PROTONVPN_PASSWORD:-}
      # Control Server API Key (for healthcheck authentication)
      HTTP_CONTROL_SERVER_PASSWORD: ${CONTROL_APIKEY:-}
      LOG_LEVEL: ${GLUETUN_LOG_LEVEL:-info}
      TZ: ${TZ:-America/New_York}
      # Email notification configuration for healthchecks
      EMAIL_TO: ${EMAIL_TO:-}
      SMTP_HOST: ${SMTP_HOST:-smtp.mail.me.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM: ${SMTP_FROM:-}
      HEALTHCHECK_TIMEOUT_SECONDS: ${GLUETUN_HEALTHCHECK_TIMEOUT_SECONDS:-60}
      # Notification rate limiting (5 minutes default)
      NOTIFICATION_COOLDOWN: ${NOTIFICATION_COOLDOWN:-300}
    ports:
      - ${QBITTORRENT_PORT:-8080}:8080
    volumes:
      - gluetun-tmp:/tmp/gluetun
      - ./config/gluetun:/gluetun
      - ./scripts/healthchecks:/scripts:ro
      - ./logs:/logs
    restart: unless-stopped
    networks:
      - torrent-services-network
    stop_signal: SIGTERM
    stop_grace_period: 30s
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "sh", "/scripts/run_healthcheck.sh", "/scripts/gluetun.sh"]
      interval: 2m
      timeout: ${GLUETUN_HEALTHCHECK_TIMEOUT_SECONDS:-90}s
      retries: 3
      start_period: 180s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: ${GLUETUN_MEM_LIMIT:-512m}
    cpus: ${GLUETUN_CPUS:-1.0}

  # qBittorrent - Torrent Client
  # Routes through Gluetun VPN with automatic port forwarding
  # Port forwarding enables incoming peer connections for optimal performance
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    network_mode: "service:gluetun"
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      TZ: ${TZ:-America/New_York}
      WEBUI_PORT: 8080
      # Email notification configuration for healthchecks
      EMAIL_TO: ${EMAIL_TO:-}
      SMTP_HOST: ${SMTP_HOST:-smtp.mail.me.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM: ${SMTP_FROM:-}
      HEALTHCHECK_TIMEOUT_SECONDS: ${QBITTORRENT_HEALTHCHECK_TIMEOUT_SECONDS:-60}
    volumes:
      - ${TORRENT_MEDIA_DIR:-./media}:/media
      - ./config/qbittorrent:/config
      - ./scripts/healthchecks:/scripts:ro
      - ./logs:/logs
    depends_on:
      gluetun:
        condition: service_healthy
    restart: unless-stopped
    stop_grace_period: 120s
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "sh", "/scripts/run_healthcheck.sh", "/scripts/qbittorrent.sh"]
      interval: 5m
      timeout: ${QBITTORRENT_HEALTHCHECK_TIMEOUT_SECONDS:-120}s
      retries: 3
      start_period: 240s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: ${QBITTORRENT_MEM_LIMIT:-3500m}
    cpus: ${QBITTORRENT_CPUS:-4.0}

  # Prowlarr - Indexer Manager
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      TZ: ${TZ:-America/New_York}
      PROWLARR_API_KEY: ${PROWLARR_API_KEY:-}
      # .NET Diagnostics
      COMPlus_EnableDiagnostics: 0
      # Runtime Dir
      XDG_RUNTIME_DIR: /config/tmp
      # Email notification configuration for healthchecks
      EMAIL_TO: ${EMAIL_TO:-}
      SMTP_HOST: ${SMTP_HOST:-smtp.mail.me.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM: ${SMTP_FROM:-}
      HEALTHCHECK_TIMEOUT_SECONDS: ${PROWLARR_HEALTHCHECK_TIMEOUT_SECONDS:-60}
    volumes:
      - ./config/prowlarr:/config
      - ./scripts/healthchecks:/scripts:ro
      - ./logs:/logs
    ports:
      - ${PROWLARR_PORT:-9696}:9696
    depends_on:
      torarr:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - torrent-services-network
    healthcheck:
      test: ["CMD", "sh", "/scripts/run_healthcheck.sh", "/scripts/prowlarr.sh"]
      interval: 5m
      timeout: ${PROWLARR_HEALTHCHECK_TIMEOUT_SECONDS:-60}s
      retries: 3
      start_period: 300s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: ${PROWLARR_MEM_LIMIT:-1g}
    cpus: ${PROWLARR_CPUS:-1.0}

  # Sonarr - TV Show Management
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      TZ: ${TZ:-America/New_York}
      SONARR_API_KEY: ${SONARR_API_KEY:-}
      # Email notification configuration for healthchecks
      EMAIL_TO: ${EMAIL_TO:-}
      SMTP_HOST: ${SMTP_HOST:-smtp.mail.me.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM: ${SMTP_FROM:-}
      HEALTHCHECK_TIMEOUT_SECONDS: ${SONARR_HEALTHCHECK_TIMEOUT_SECONDS:-60}
    # Increase file descriptor limit for ExFAT volumes on OrbStack
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - ${TORRENT_MEDIA_DIR:-./media}:/media
      - ${DVD_MEDIA_DIR:-./dvd-rips}:/dvd-rips
      - ./config/sonarr:/config
      - ./scripts/healthchecks:/scripts:ro
      - ./logs:/logs
    ports:
      - ${SONARR_PORT:-8989}:8989
    restart: unless-stopped
    stop_grace_period: 60s
    networks:
      - torrent-services-network
    healthcheck:
      test: ["CMD", "sh", "/scripts/run_healthcheck.sh", "/scripts/sonarr.sh"]
      interval: 5m
      timeout: ${SONARR_HEALTHCHECK_TIMEOUT_SECONDS:-60}s
      retries: 3
      start_period: 300s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: ${SONARR_MEM_LIMIT:-1g}
    cpus: ${SONARR_CPUS:-1.0}

  # Radarr - Movie Management
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      TZ: ${TZ:-America/New_York}
      RADARR_API_KEY: ${RADARR_API_KEY:-}
      # Email notification configuration for healthchecks
      EMAIL_TO: ${EMAIL_TO:-}
      SMTP_HOST: ${SMTP_HOST:-smtp.mail.me.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM: ${SMTP_FROM:-}
      HEALTHCHECK_TIMEOUT_SECONDS: ${RADARR_HEALTHCHECK_TIMEOUT_SECONDS:-60}
    # Increase file descriptor limit for ExFAT volumes on OrbStack
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - ${TORRENT_MEDIA_DIR:-./media}:/media
      - ${DVD_MEDIA_DIR:-./dvd-rips}:/dvd-rips
      - ./config/radarr:/config
      - ./scripts/healthchecks:/scripts:ro
      - ./logs:/logs
    ports:
      - ${RADARR_PORT:-7878}:7878
    restart: unless-stopped
    stop_grace_period: 30s
    networks:
      - torrent-services-network
    healthcheck:
      test: ["CMD", "sh", "/scripts/run_healthcheck.sh", "/scripts/radarr.sh"]
      interval: 5m
      timeout: ${RADARR_HEALTHCHECK_TIMEOUT_SECONDS:-60}s
      retries: 3
      start_period: 300s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: ${RADARR_MEM_LIMIT:-1g}
    cpus: ${RADARR_CPUS:-1.0}

  # Bazarr - Subtitle Management
  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      TZ: ${TZ:-America/New_York}
      BAZARR_API_KEY: ${BAZARR_API_KEY:-}
      # Email notification configuration for healthchecks
      EMAIL_TO: ${EMAIL_TO:-}
      SMTP_HOST: ${SMTP_HOST:-smtp.mail.me.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM: ${SMTP_FROM:-}
      HEALTHCHECK_TIMEOUT_SECONDS: ${BAZARR_HEALTHCHECK_TIMEOUT_SECONDS:-60}
    # Increase file descriptor limit for ExFAT volumes on OrbStack
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - ${TORRENT_MEDIA_DIR:-./media}:/media
      - ${DVD_MEDIA_DIR:-./dvd-rips}:/dvd-rips
      - ./config/bazarr:/config
      - ./scripts/healthchecks:/scripts:ro
      - ./logs:/logs
    ports:
      - ${BAZARR_PORT:-6767}:6767
    depends_on:
      sonarr:
        condition: service_healthy
      radarr:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - torrent-services-network
    healthcheck:
      test: ["CMD", "sh", "/scripts/run_healthcheck.sh", "/scripts/bazarr.sh"]
      interval: 5m
      timeout: ${BAZARR_HEALTHCHECK_TIMEOUT_SECONDS:-60}s
      retries: 3
      start_period: 330s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: ${BAZARR_MEM_LIMIT:-1g}
    cpus: ${BAZARR_CPUS:-1.0}

  # Unpackarr - Wrapper around official Unpackerr for extracting completed downloads
  unpackarr:
    image: ghcr.io/eslutz/unpackarr:v1.0.0
    container_name: unpackarr
    init: true
    environment:
      # Wrapper configuration
      LOG_LEVEL: ${UNPACKARR_LOG_LEVEL:-INFO}
      HEALTH_PORT: ${UNPACKARR_PORT:-9092}
      # Unpackerr configuration (passthrough with UN_ prefix)
      UN_PARALLEL: ${UNPACKARR_PARALLEL:-1}
      UN_DELETE_ORIG: ${UNPACKARR_DELETE_ORIG:-false}
      UN_POLL_INTERVAL: ${UNPACKARR_POLL_INTERVAL:-5m}
      UN_SONARR_0_URL: http://sonarr:8989
      UN_SONARR_0_API_KEY: ${SONARR_API_KEY:-}
      UN_SONARR_0_PATHS_0: /media
      UN_SONARR_0_PROTOCOLS: torrent
      UN_RADARR_0_URL: http://radarr:7878
      UN_RADARR_0_API_KEY: ${RADARR_API_KEY:-}
      UN_RADARR_0_PATHS_0: /media
      UN_RADARR_0_PROTOCOLS: torrent
      UN_WEBSERVER_METRICS: ${UNPACKARR_ENABLE_METRICS:-false}
      UN_WEBSERVER_LISTEN_ADDR: 0.0.0.0:5656
    volumes:
      - ${TORRENT_MEDIA_DIR:-./media}:/media
      - ./logs:/logs
    ports:
      - ${UNPACKARR_PORT:-9092}:9092
      - "5656:5656"
    depends_on:
      sonarr:
        condition: service_healthy
      radarr:
        condition: service_healthy
    restart: unless-stopped
    stop_grace_period: 30s
    networks:
      - torrent-services-network
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "wget", "-qO-", "--timeout=20", "http://localhost:9092/health"]
      interval: 5m
      timeout: 30s
      retries: 3
      start_period: 180s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: ${UNPACKARR_MEM_LIMIT:-512m}
    cpus: ${UNPACKARR_CPUS:-0.5}

  # Tdarr Server - Transcode manager (waits for qBittorrent to complete torrents)
  tdarr-server:
    image: ghcr.io/haveagitgat/tdarr:latest
    container_name: tdarr-server
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      TZ: ${TZ:-America/New_York}
      serverIP: 0.0.0.0
      serverPort: ${TDARR_SERVER_PORT:-8266}
      webUIPort: ${TDARR_WEBUI_PORT:-8265}
      internalNode: true
      inContainer: true
      nodeName: TdarrNode
      # Email notification configuration for healthchecks
      EMAIL_TO: ${EMAIL_TO:-}
      SMTP_HOST: ${SMTP_HOST:-smtp.mail.me.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM: ${SMTP_FROM:-}
      HEALTHCHECK_TIMEOUT_SECONDS: ${TDARR_HEALTHCHECK_TIMEOUT_SECONDS:-60}
    # Increase file descriptor limit for ExFAT volumes on OrbStack
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - ${TORRENT_MEDIA_DIR:-./media}:/media
      - ${DVD_MEDIA_DIR:-./dvd-rips}:/dvd-rips
      - ./config/tdarr/server:/app/server
      - ./config/tdarr/configs:/app/configs
      - ./config/tdarr/logs:/app/logs
      - ./scripts/healthchecks:/scripts:ro
      - ./logs:/logs
    ports:
      - ${TDARR_WEBUI_PORT:-8265}:8265
      - ${TDARR_SERVER_PORT:-8266}:8266
    restart: unless-stopped
    stop_grace_period: 30s
    networks:
      - torrent-services-network
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "sh", "/scripts/run_healthcheck.sh", "/scripts/tdarr.sh"]
      interval: 5m
      timeout: ${TDARR_HEALTHCHECK_TIMEOUT_SECONDS:-60}s
      retries: 3
      start_period: 420s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: ${TDARR_SERVER_MEM_LIMIT:-1g}
    cpus: ${TDARR_SERVER_CPUS:-1.0}

  # Tdarr Node - Transcode worker (processes files after torrents complete)
  # For horizontal scaling, use docker-compose.tdarr-node.yml to add more nodes dynamically
  tdarr-node:
    image: ghcr.io/haveagitgat/tdarr:latest
    container_name: tdarr-node
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      TZ: ${TZ:-America/New_York}
      nodeID: TdarrNode
      nodeIP: 0.0.0.0
      nodePort: ${TDARR_NODE_PORT:-8267}
      serverIP: tdarr-server
      serverPort: ${TDARR_SERVER_PORT:-8266}
      # Optional: Set worker limits per node based on hardware
      transcodeGpuWorkers: ${TDARR_GPU_WORKERS:-0}
      transcodeCpuWorkers: ${TDARR_CPU_WORKERS:-2}
    # Increase file descriptor limit for ExFAT volumes on OrbStack
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - ${TORRENT_MEDIA_DIR:-./media}:/media
      - ${DVD_MEDIA_DIR:-./dvd-rips}:/dvd-rips
      - ./config/tdarr/configs:/app/configs
      - ./config/tdarr/logs:/app/logs
      - tdarr-transcode-cache:/temp
    ports:
      - ${TDARR_NODE_PORT:-8267}:8267
    depends_on:
      tdarr-server:
        condition: service_healthy
    restart: unless-stopped
    stop_grace_period: 30s
    networks:
      - torrent-services-network
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: ${TDARR_NODE_MEM_LIMIT:-2g}
    cpus: ${TDARR_NODE_CPUS:-2.0}

  # Jellyseerr - Request management and media discovery tool
  jellyseerr:
    image: fallenbagel/jellyseerr:latest
    container_name: jellyseerr
    init: true
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      TZ: ${TZ:-America/New_York}
      # Email notification configuration for healthchecks
      EMAIL_TO: ${EMAIL_TO:-}
      SMTP_HOST: ${SMTP_HOST:-smtp.mail.me.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM: ${SMTP_FROM:-}
      HEALTHCHECK_TIMEOUT_SECONDS: ${JELLYSEERR_HEALTHCHECK_TIMEOUT_SECONDS:-60}
    volumes:
      - ./config/jellyseerr:/app/config
      - ./scripts/healthchecks:/scripts:ro
      - ./logs:/logs
    ports:
      - ${JELLYSEERR_PORT:-5055}:5055
    depends_on:
      sonarr:
        condition: service_healthy
      radarr:
        condition: service_healthy
    restart: unless-stopped
    stop_grace_period: 30s
    networks:
      - torrent-services-network
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "sh", "/scripts/run_healthcheck.sh", "/scripts/jellyseerr.sh"]
      interval: 5m
      timeout: ${JELLYSEERR_HEALTHCHECK_TIMEOUT_SECONDS:-60}s
      retries: 3
      start_period: 420s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: ${JELLYSEERR_MEM_LIMIT:-512m}
    cpus: ${JELLYSEERR_CPUS:-1.0}

  # Swiparr - Jellyfin media discovery swipe UI
  swiparr:
    image: ghcr.io/m3sserstudi0s/swiparr:latest
    container_name: swiparr
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      TZ: ${TZ:-America/New_York}
      JELLYFIN_URL: ${SWIPARR_JELLYFIN_URL:-}
      JELLYFIN_PUBLIC_URL: ${SWIPARR_JELLYFIN_PUBLIC_URL:-}
      AUTH_SECRET: ${SWIPARR_AUTH_SECRET:-}
      JELLYFIN_USE_WATCHLIST: ${SWIPARR_USE_WATCHLIST:-false}
      USE_SECURE_COOKIES: ${SWIPARR_USE_SECURE_COOKIES:-false}
      PORT: 4321
      HOSTNAME: 0.0.0.0
    volumes:
      - ./config/swiparr:/app/data
      - ./logs:/logs
    ports:
      - ${SWIPARR_PORT:-4321}:4321
    restart: unless-stopped
    stop_grace_period: 30s
    networks:
      - torrent-services-network
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: ${SWIPARR_MEM_LIMIT:-512m}
    cpus: ${SWIPARR_CPUS:-1.0}

  # Email notifier for container events
  events-notifier:
    image: debian:stable-slim
    container_name: events-notifier
    restart: unless-stopped
    environment:
      - TZ=${TZ:-America/New_York}
      - EMAIL_TO=${EMAIL_TO:-}
      - SMTP_HOST=${SMTP_HOST:-smtp.mail.me.com}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - SMTP_FROM=${SMTP_FROM:-}
      - NOTIFICATION_COOLDOWN=${NOTIFICATION_COOLDOWN:-300}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:r
      - ./config:/config:rw
      - ./scripts/healthchecks:/scripts:ro
      - ./logs:/logs
      - /etc/localtime:/etc/localtime:ro
    networks:
      - torrent-services-network
    command:
      - "sh"
      - "-c"
      - |
        apt-get update && apt-get install -y jq msmtp ca-certificates docker.io tzdata && \
        printf "defaults\nauth on\ntls on\ntls_starttls on\ntls_certcheck on\ntls_trust_file /etc/ssl/certs/ca-certificates.crt\nlogfile /var/log/msmtp.log\ntimeout 15\n\naccount default\nhost $$SMTP_HOST\nport $$SMTP_PORT\nfrom $$SMTP_FROM\nuser $$SMTP_USER\npassword $$SMTP_PASSWORD\n" > /etc/msmtprc && \
        chmod 600 /etc/msmtprc && \
        sh /scripts/docker_events_notifier.sh
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    # You must install jq in this container for config parsing

  # Forwardarr - Sync Gluetun forwarded port to qBittorrent with metrics + health endpoints
  forwardarr:
    image: ghcr.io/eslutz/forwardarr:latest
    container_name: forwardarr
    init: true
    environment:
      GLUETUN_PORT_FILE: /tmp/gluetun/forwarded_port
      TORRENT_CLIENT_URL: http://gluetun:8080
      TORRENT_CLIENT_USER: ${SERVICE_USER:-admin}
      TORRENT_CLIENT_PASSWORD: ${QBITTORRENT_PASSWORD:-}
      SYNC_INTERVAL: ${FORWARDARR_SYNC_INTERVAL:-60}
      LOG_LEVEL: ${FORWARDARR_LOG_LEVEL:-info}
    volumes:
      - gluetun-tmp:/tmp/gluetun:ro
      - ./logs:/logs
    ports:
      - ${FORWARDARR_PORT:-9090}:9090
    depends_on:
      gluetun:
        condition: service_healthy
      qbittorrent:
        condition: service_healthy
    networks:
      - torrent-services-network
    restart: unless-stopped
    deploy:
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 5
        window: 120s
    stop_grace_period: 30s
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "wget", "-qO-", "--timeout=30", "http://localhost:9090/health"]
      interval: 1m
      timeout: 60s
      retries: 3
      start_period: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: ${FORWARDARR_MEM_LIMIT:-256m}
    cpus: ${FORWARDARR_CPUS:-0.5}

  # Torarr - SOCKS5 proxy for anonymous indexer access
  # Provides access to .onion sites and bypasses blocks
  torarr:
    image: ghcr.io/eslutz/torarr:latest
    container_name: torarr
    init: true
    environment:
      TZ: ${TZ:-America/New_York}
    ports:
      - 127.0.0.1:${TORARR_PORT:-9050}:9050 # SOCKS5 proxy
      - ${TORARR_HEALTH_PORT:-9091}:9091 # Health/metrics endpoint
    volumes:
      - tor-data:/var/lib/tor
      - ./logs:/logs
    restart: unless-stopped
    networks:
      - torrent-services-network
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "wget", "-qO-", "--timeout=15", "http://localhost:9091/health"]
      interval: 5m
      timeout: 20s
      retries: 3
      start_period: 360s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: ${TOR_PROXY_MEM_LIMIT:-256m}
    cpus: ${TOR_PROXY_CPUS:-0.5}

  # qBittorrent Exporter for Prometheus
  qbittorrent-exporter:
    image: ghcr.io/martabal/qbittorrent-exporter:latest
    container_name: qbittorrent-exporter
    environment:
      QBITTORRENT_BASE_URL: http://gluetun:${QBITTORRENT_PORT:-8080}
      QBITTORRENT_USERNAME: ${SERVICE_USER:-admin}
      QBITTORRENT_PASSWORD: ${QBITTORRENT_PASSWORD:-}
      EXPORTER_PORT: 8090
      LOG_LEVEL: ${QBITTORRENT_EXPORTER_LOG_LEVEL:-INFO}
      ENABLE_TRACKER: true
    depends_on:
      qbittorrent:
        condition: service_healthy
    ports:
      - "8090:8090"
    networks:
      - torrent-services-network
    restart: unless-stopped
    deploy:
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 5
        window: 120s
    profiles:
      - monitoring
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: ${QBITTORRENT_EXPORTER_MEM_LIMIT:-128m}
    cpus: ${QBITTORRENT_EXPORTER_CPUS:-0.25}

  # Scraparr - Unified *arr Prometheus exporter
  scraparr:
    image: ghcr.io/thecfu/scraparr:latest
    container_name: scraparr
    environment:
      GENERAL_PORT: 7100
      GENERAL_PATH: /metrics
      SONARR_URL: http://sonarr:8989
      SONARR_API_KEY: ${SONARR_API_KEY:-}
      SONARR_INTERVAL: 30
      RADARR_URL: http://radarr:7878
      RADARR_API_KEY: ${RADARR_API_KEY:-}
      RADARR_INTERVAL: 30
      PROWLARR_URL: http://prowlarr:9696
      PROWLARR_API_KEY: ${PROWLARR_API_KEY:-}
      PROWLARR_INTERVAL: 30
      BAZARR_URL: http://bazarr:6767
      BAZARR_API_KEY: ${BAZARR_API_KEY:-}
      BAZARR_INTERVAL: 30
    depends_on:
      sonarr:
        condition: service_healthy
      radarr:
        condition: service_healthy
      prowlarr:
        condition: service_healthy
      bazarr:
        condition: service_healthy
    ports:
      - "7100:7100"
    networks:
      - torrent-services-network
    restart: unless-stopped
    profiles:
      - monitoring
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: ${SCRAPARR_MEM_LIMIT:-256m}
    cpus: ${SCRAPARR_CPUS:-0.5}

  autoheal:
    image: tmknight88/docker-autoheal:latest
    container_name: autoheal
    restart: unless-stopped
    read_only: true
    network_mode: none
    environment:
      AUTOHEAL_CONNECTION_TYPE: socket
      AUTOHEAL_MONITOR_ALL: true
      AUTOHEAL_INTERVAL: 60
      AUTOHEAL_START_DELAY: 600
      AUTOHEAL_STOP_TIMEOUT: ${AUTOHEAL_STOP_TIMEOUT:-30}
      AUTOHEAL_LOG_PERSIST: true
      # Limit restart attempts to prevent endless loops
      AUTOHEAL_DEFAULT_STOP: ${AUTOHEAL_DEFAULT_STOP:-true}
      AUTOHEAL_MAX_RETRIES: ${AUTOHEAL_MAX_RETRIES:-2}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/localtime:/etc/localtime:ro
      - ./logs/autoheal:/opt/docker-autoheal
    stop_grace_period: 60s
    healthcheck:
      disable: true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: ${AUTOHEAL_MEM_LIMIT:-256m}
    cpus: ${AUTOHEAL_CPUS:-0.25}

  # Log Streamer - Real-time Docker log aggregation with Fluent Bit
  # Streams container logs to ./logs/<service>/ for unified log access
  log-streamer:
    image: docker:latest
    container_name: log-streamer
    restart: unless-stopped
    command: sh /scripts/utilities/stream_docker_logs.sh
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./scripts:/scripts:ro
      - ./logs:/logs:rw
    networks:
      - torrent-services-network
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: ${LOG_STREAMER_MEM_LIMIT:-256m}
    cpus: ${LOG_STREAMER_CPUS:-0.25}

networks:
  torrent-services-network:
    name: torrent-net
    driver: bridge

volumes:
  gluetun-tmp:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
  tor-data:
  tdarr-transcode-cache:
