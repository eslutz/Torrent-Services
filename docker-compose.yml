services:
  # Gluetun - VPN Client (ProtonVPN with Port Forwarding)
  # Provides VPN tunnel with automatic port forwarding for qBittorrent
  # Port forwarding enables incoming peer connections for better torrent performance
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      # ProtonVPN Configuration
      - VPN_SERVICE_PROVIDER=protonvpn
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - WIREGUARD_ADDRESSES=${WIREGUARD_ADDRESSES}

      # Server Selection
      - SERVER_COUNTRIES=${SERVER_COUNTRIES:-}
      - FREE_ONLY=${FREE_ONLY:-}

      # Port Forwarding (automatic)
      - VPN_PORT_FORWARDING=on
      - VPN_PORT_FORWARDING_PROVIDER=protonvpn

      # Timezone
      - TZ=${TZ:-America/New_York}
    ports:
      # qBittorrent Web UI
      - 8080:8080
      # Forwarded port will be automatically assigned by ProtonVPN
      # Check with: docker exec gluetun cat /tmp/gluetun/forwarded_port
    volumes:
      - ./config/gluetun:/gluetun
      - gluetun-tmp:/tmp/gluetun
    restart: unless-stopped
    networks:
      - torrent-services-network
    healthcheck:
      test: ["CMD-SHELL", "ping -c 1 1.1.1.1 > /dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # qBittorrent - Torrent Client
  # Routes through Gluetun VPN with automatic port forwarding
  # Port forwarding enables incoming peer connections for optimal performance
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    network_mode: "service:gluetun"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
      - WEBUI_PORT=8080
    volumes:
      - ./config/qbittorrent:/config
      - ${DATA_DIR:-./media}:/media
    depends_on:
      gluetun:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # qBit Port Sync - Automatically updates qBittorrent port from Gluetun
  # Monitors Gluetun's forwarded port and updates qBittorrent when it changes
  qbit-port-sync:
    image: alpine:latest
    container_name: qbit-port-sync
    environment:
      - QBIT_HOST=gluetun:8080
      - QBIT_USER=${QBIT_USER:-admin}
      - QBIT_PASS=${QBIT_PASS}
    volumes:
      - gluetun-tmp:/tmp/gluetun:ro
      - ./qbit-port-sync.sh:/app/qbit-port-sync.sh:ro
    depends_on:
      - gluetun
      - qbittorrent
    networks:
      - torrent-services-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "grep -q 'OK' /tmp/qbit-port-sync-status || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    command: sh /app/update-port.sh
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Prowlarr - Indexer Manager
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    volumes:
      - ./config/prowlarr:/config
    ports:
      - 9696:9696
    restart: unless-stopped
    networks:
      - torrent-services-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9696/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Sonarr - TV Show Management
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    volumes:
      - ./config/sonarr:/config
      - ${DATA_DIR:-./media}:/media
    ports:
      - 8989:8989
    restart: unless-stopped
    networks:
      - torrent-services-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8989/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Radarr - Movie Management
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    volumes:
      - ./config/radarr:/config
      - ${DATA_DIR:-./media}:/media
    ports:
      - 7878:7878
    restart: unless-stopped
    networks:
      - torrent-services-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7878/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Bazarr - Subtitle Management
  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    volumes:
      - ./config/bazarr:/config
      - ${DATA_DIR:-./media}:/media
    ports:
      - 6767:6767
    restart: unless-stopped
    networks:
      - torrent-services-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6767/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Tor - SOCKS5 proxy for anonymous indexer access
  # Provides access to .onion sites and bypasses blocks
  tor-proxy:
    image: dperson/torproxy:latest
    container_name: tor-proxy
    environment:
      - TZ=${TZ:-America/New_York}
    ports:
      - 127.0.0.1:9050:9050 # SOCKS5 proxy
      - 127.0.0.1:9051:9051 # Control port
    restart: unless-stopped
    networks:
      - torrent-services-network
    healthcheck:
      test: ["CMD", "curl", "--socks5-hostname", "localhost:9050", "https://check.torproject.org/"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  torrent-services-network:
    name: torrent-net
    driver: bridge

volumes:
  gluetun-tmp:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
