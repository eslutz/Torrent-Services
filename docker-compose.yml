services:
  # Gluetun - VPN Client (ProtonVPN with Port Forwarding)
  # Provides VPN tunnel with automatic port forwarding for Transmission
  # Port forwarding enables incoming peer connections for better torrent performance
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      # ProtonVPN Configuration
      - VPN_SERVICE_PROVIDER=protonvpn
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - WIREGUARD_ADDRESSES=${WIREGUARD_ADDRESSES}

      # Server Selection
      - SERVER_COUNTRIES=${SERVER_COUNTRIES:-}
      - FREE_ONLY=${FREE_ONLY:-}

      # Port Forwarding (automatic)
      - VPN_PORT_FORWARDING=on
      - VPN_PORT_FORWARDING_PROVIDER=protonvpn

      # Firewall settings
      - FIREWALL_OUTBOUND_SUBNETS=0.0.0.0/0

      # Timezone
      - TZ=${TZ:-America/New_York}
    ports:
      # Transmission Web UI
      - 9091:9091
      # Forwarded port will be automatically assigned by ProtonVPN
      # Check with: docker exec gluetun cat /tmp/gluetun/forwarded_port
    volumes:
      - ./config/gluetun:/gluetun
    restart: unless-stopped
    networks:
      - torrent-services-network
    healthcheck:
      test: ["CMD-SHELL", "ping -c 1 1.1.1.1 > /dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Transmission - Torrent Client
  # Routes through Gluetun VPN with automatic port forwarding
  # Port forwarding enables incoming peer connections for optimal performance
  transmission:
    image: lscr.io/linuxserver/transmission:latest
    container_name: transmission
    network_mode: "service:gluetun"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
      - USER=${TRANSMISSION_USER:-admin}
      - PASS=${TRANSMISSION_PASS}
    volumes:
      - ./config/transmission:/config
      - ${DATA_DIR:-./data}:/data
    depends_on:
      gluetun:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Port Updater - Automatically updates Transmission port from Gluetun
  # Monitors Gluetun's forwarded port and updates Transmission when it changes
  transmission-port-updater:
    image: alpine:latest
    container_name: transmission-port-updater
    environment:
      - TRANSMISSION_HOST=gluetun:9091
      - TRANSMISSION_USER=${TRANSMISSION_USER:-admin}
      - TRANSMISSION_PASS=${TRANSMISSION_PASS}
    volumes:
      - ./config/gluetun:/gluetun:ro
    depends_on:
      - gluetun
      - transmission
    networks:
      - torrent-services-network
    restart: unless-stopped
    command: >
      sh -c '
      apk add --no-cache curl bash inotify-tools &&

      update_port() {
        if [ -z "$$TRANSMISSION_PASS" ]; then
          echo "âš ï¸  Warning: TRANSMISSION_PASS not set in .env - skipping port update"
          return
        fi

        FORWARDED_PORT=$$(cat /gluetun/forwarded_port 2>/dev/null | tr -d "\\n\\r")

        if [ -z "$$FORWARDED_PORT" ]; then
          echo "â³ Waiting for Gluetun to establish port forwarding..."
          return
        fi

        echo "âœ“ Found forwarded port: $$FORWARDED_PORT"

        # Get session ID for Transmission RPC
        SESSION_ID=$$(curl -s -u "$$TRANSMISSION_USER:$$TRANSMISSION_PASS" \
          "http://$$TRANSMISSION_HOST/transmission/rpc" 2>/dev/null | \
          grep -oP "X-Transmission-Session-Id: \K[^<]+")

        if [ -z "$$SESSION_ID" ]; then
          echo "âŒ Failed to get Transmission session ID"
          return
        fi

        # Get current port from Transmission
        CURRENT_PORT=$$(curl -s -u "$$TRANSMISSION_USER:$$TRANSMISSION_PASS" \
          -H "X-Transmission-Session-Id: $$SESSION_ID" \
          -d "{\"method\":\"session-get\",\"arguments\":{\"fields\":[\"peer-port\"]}}" \
          "http://$$TRANSMISSION_HOST/transmission/rpc" 2>/dev/null | \
          grep -oP "\"peer-port\":\K[0-9]+")

        if [ "$$CURRENT_PORT" != "$$FORWARDED_PORT" ]; then
          echo "ðŸ”„ Updating Transmission port from $$CURRENT_PORT to $$FORWARDED_PORT"

          curl -s -u "$$TRANSMISSION_USER:$$TRANSMISSION_PASS" \
            -H "X-Transmission-Session-Id: $$SESSION_ID" \
            -d "{\"method\":\"session-set\",\"arguments\":{\"peer-port\":$$FORWARDED_PORT}}" \
            "http://$$TRANSMISSION_HOST/transmission/rpc" 2>/dev/null

          echo "âœ“ Successfully updated Transmission port to: $$FORWARDED_PORT"
        else
          echo "âœ“ Port already correct: $$FORWARDED_PORT"
        fi
      }

      echo "ðŸ‘€ Watching for port changes..."

      # Initial update on startup
      sleep 10
      update_port

      # Watch for file changes using inotify
      while true; do
        inotifywait -e modify,create,moved_to /gluetun/forwarded_port 2>/dev/null
        echo "ðŸ”” Port file changed, updating..."
        sleep 2
        update_port
      done
      '
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Prowlarr - Indexer Manager
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    volumes:
      - ./config/prowlarr:/config
    ports:
      - 9696:9696
    restart: unless-stopped
    networks:
      - torrent-services-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9696/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Sonarr - TV Show Management
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    volumes:
      - ./config/sonarr:/config
      - ${DATA_DIR:-./data}:/data
    ports:
      - 8989:8989
    restart: unless-stopped
    networks:
      - torrent-services-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8989/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Radarr - Movie Management
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    volumes:
      - ./config/radarr:/config
      - ${DATA_DIR:-./data}:/data
    ports:
      - 7878:7878
    restart: unless-stopped
    networks:
      - torrent-services-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7878/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Bazarr - Subtitle Management
  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    volumes:
      - ./config/bazarr:/config
      - ${DATA_DIR:-./data}:/data
    ports:
      - 6767:6767
    restart: unless-stopped
    networks:
      - torrent-services-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6767/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  torrent-services-network:
    name: torrent-net
    driver: bridge
