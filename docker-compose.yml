services:
  # Gluetun - VPN Client (ProtonVPN with Port Forwarding)
  # Provides VPN tunnel with automatic port forwarding for qBittorrent
  # Port forwarding enables incoming peer connections for better torrent performance
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      # ProtonVPN Configuration
      - VPN_SERVICE_PROVIDER=protonvpn
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - WIREGUARD_ADDRESSES=${WIREGUARD_ADDRESSES}

      # Server Selection
      - SERVER_COUNTRIES=${SERVER_COUNTRIES:-}
      - FREE_ONLY=${FREE_ONLY:-}

      # Port Forwarding (automatic)
      - VPN_PORT_FORWARDING=on
      - VPN_PORT_FORWARDING_PROVIDER=protonvpn

      # Firewall settings
      - FIREWALL_OUTBOUND_SUBNETS=0.0.0.0/0

      # Timezone
      - TZ=${TZ:-America/New_York}
    ports:
      # qBittorrent Web UI
      - 8080:8080
      # Forwarded port will be automatically assigned by ProtonVPN
      # Check with: docker exec gluetun cat /tmp/gluetun/forwarded_port
    volumes:
      - ./config/gluetun:/gluetun
    restart: unless-stopped
    networks:
      - torrent-services-network
    healthcheck:
      test: ["CMD-SHELL", "ping -c 1 1.1.1.1 > /dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # qBittorrent - Torrent Client
  # Routes through Gluetun VPN with automatic port forwarding
  # Port forwarding enables incoming peer connections for optimal performance
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    network_mode: "service:gluetun"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
      - WEBUI_PORT=8080
    volumes:
      - ./config/qbittorrent:/config
      - ${DATA_DIR:-./media}:/media
    depends_on:
      gluetun:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Port Updater - Automatically updates qBittorrent port from Gluetun
  # Monitors Gluetun's forwarded port and updates qBittorrent when it changes
  qbt-port-updater:
    image: alpine:latest
    container_name: qbt-port-updater
    environment:
      - QB_HOST=gluetun:8080
      - QB_USER=${QB_USER:-admin}
      - QB_PASS=${QB_PASS}
    volumes:
      - ./config/gluetun:/gluetun:ro
    depends_on:
      - gluetun
      - qbittorrent
    networks:
      - torrent-services-network
    restart: unless-stopped
    command: >
      sh -c '
      apk add --no-cache curl bash inotify-tools &&

      update_port() {
        if [ -z "$$QB_PASS" ]; then
          echo "âš ï¸  Warning: QB_PASS not set in .env - skipping port update"
          return
        fi

        FORWARDED_PORT=$$(cat /gluetun/forwarded_port 2>/dev/null | tr -d "\\n\\r")

        if [ -z "$$FORWARDED_PORT" ]; then
          echo "â³ Waiting for Gluetun to establish port forwarding..."
          return
        fi

        echo "âœ“ Found forwarded port: $$FORWARDED_PORT"

        COOKIE=$$(curl -s -i --header "Referer: http://$$QB_HOST" \
          --data "username=$$QB_USER&password=$$QB_PASS" \
          "http://$$QB_HOST/api/v2/auth/login" 2>/dev/null | \
          grep -i set-cookie | cut -d" " -f2)

        if [ -z "$$COOKIE" ]; then
          echo "âŒ Failed to authenticate with qBittorrent"
          return
        fi

        CURRENT_PORT=$$(curl -s --cookie "$$COOKIE" \
          "http://$$QB_HOST/api/v2/app/preferences" 2>/dev/null | \
          grep -o "\"listen_port\":[0-9]*" | cut -d":" -f2)

        if [ "$$CURRENT_PORT" != "$$FORWARDED_PORT" ]; then
          echo "ðŸ”„ Updating qBittorrent port from $$CURRENT_PORT to $$FORWARDED_PORT"

          curl -s -X POST "http://$$QB_HOST/api/v2/app/setPreferences" \
            --cookie "$$COOKIE" \
            --data "json={\"listen_port\":$$FORWARDED_PORT}" 2>/dev/null

          echo "âœ“ Successfully updated qBittorrent port to: $$FORWARDED_PORT"
        else
          echo "âœ“ Port already correct: $$FORWARDED_PORT"
        fi
      }

      echo "ðŸ‘€ Watching for port changes..."

      # Initial update on startup
      sleep 10
      update_port

      # Watch for file changes using inotify
      while true; do
        inotifywait -e modify,create,moved_to /gluetun/forwarded_port 2>/dev/null
        echo "ðŸ”” Port file changed, updating..."
        sleep 2
        update_port
      done
      '
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Prowlarr - Indexer Manager
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    volumes:
      - ./config/prowlarr:/config
    ports:
      - 9696:9696
    restart: unless-stopped
    networks:
      - torrent-services-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9696/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Sonarr - TV Show Management
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    volumes:
      - ./config/sonarr:/config
      - ${DATA_DIR:-./media}:/media
    ports:
      - 8989:8989
    restart: unless-stopped
    networks:
      - torrent-services-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8989/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Radarr - Movie Management
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    volumes:
      - ./config/radarr:/config
      - ${DATA_DIR:-./media}:/media
    ports:
      - 7878:7878
    restart: unless-stopped
    networks:
      - torrent-services-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7878/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Bazarr - Subtitle Management
  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    volumes:
      - ./config/bazarr:/config
      - ${DATA_DIR:-./media}:/media
    ports:
      - 6767:6767
    restart: unless-stopped
    networks:
      - torrent-services-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6767/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  torrent-services-network:
    name: torrent-net
    driver: bridge
